<!DOCTYPE html>
<html lang=en>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Multi-column Tag Editor</title>
	<style>
		body {
			font-family: sans-serif;
			margin: 0;
			display: flex;
			height: 100vh;
			overflow: hidden;
			background-color: #121212;
			color: #e0e0e0;
		}

		.left,
		.right {
			padding: 10px;
			overflow-y: auto;
		}

		.left {
			width: 40%;
			border-right: 1px solid #444;
			display: flex;
			flex-direction: column;
		}

		.right {
			width: 60%;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.topbar,
		.template-box,
		.footer-controls {
			background-color: #1e1e1e;
			padding: 10px;
			border-radius: 6px;
		}

		.topbar select {
			background-color: #2c2c2c;
			color: #e0e0e0;
			border: 1px solid #555;
			padding: 4px;
		}

		.category-buttons button,
		.template-box button {
			margin: 2px;
			background-color: #2c2c2c;
			color: #e0e0e0;
			border: 1px solid #555;
			border-radius: 4px;
			cursor: pointer;
			padding: 5px 10px;
		}

		.tag-list {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			background-color: #1e1e1e;
			padding: 10px;
			border-radius: 6px;
			margin-top: 10px;
			overflow-y: auto;
			scrollbar-gutter: stable;
		}

		.tag {
			padding: 5px 8px;
			background: #c2c2c2;
			border-radius: 4px;
			cursor: pointer;
		}

		.tag.selected {
			background: #1fce62;
			color: #000;
		}

		.tag-category h3 {
			margin-top: 15px;
			font-size: 18px;
			font-weight: bold;
			color: #ffcc00;
		}

		.tag-subcategory h4 {
			margin: 8px 0 4px;
			font-size: 14px;
			font-weight: bold;
			color: #66ccff;
		}

		.output-box {
			border: 1px solid #555;
			background-color: #1e1e1e;
			padding: 5px;
			position: relative;
		}

		.output-box.selected {
			border: 2px solid #00BCD4;
		}

		.output-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 5px;
			margin-bottom: 5px;
		}

		.output-tag {
			background: #4caf50;
			padding: 4px 6px;
			border-radius: 4px;
		}

		.output-tag span {
			margin-left: 4px;
			cursor: pointer;
			color: red;
		}

		.output-box textarea {
			width: 100%;
			/* ä½”æ»¿çˆ¶å®¹å™¨ */
			height: 60px;
			/* é è¨­é«˜åº¦ */
			resize: none;
			background-color: #333;
			color: #eee;
			border: none;
			border-radius: 4px;
			padding: 5px;
			font-size: 14px;
			/* æ¡Œæ©Ÿç”¨å°ä¸€é»çš„å­—é«” */
		}


		.output-controls button {
			margin-left: 5px;
		}

		.template-box span {
			cursor: pointer;
			margin-left: 5px;
			color: red;
		}

		.footer-controls {
			margin-top: auto;
			display: flex;
			justify-content: space-between;
			padding: 10px;
			background: #1e1e1e;
			border-radius: 6px;
		}

		.footer-controls>div {
			display: flex;
			gap: 10px;
		}

		#templateToggle {
			display: none;
		}

		.group-buttons button.active,
		.category-buttons button.active {
			background-color: #00bcd4;
			color: #000;
			border: 1px solid #00bcd4;
		}

		/* æ‰‹æ©Ÿå°ˆç”¨èª¿æ•´ */
		@media (max-width: 768px) {

			body {
				flex-direction: column;
				overflow-x: hidden;
				/* é˜²æ­¢æ©«å‘æ»‘å‹• */
			}

			/* å¤§é¡å€å¡Šå›ºå®šå…©è¡Œ */
			.group-buttons {
				display: flex;
				flex-wrap: wrap;
				overflow-y: auto;
				line-height: 1.6em;
				max-height: calc(1.6em * 2 + 12px);
				min-height: calc(1.6em * 2 + 12px);
				margin-bottom: 6px;
				flex-shrink: 0;
				background: #1e1e1e;
				border-radius: 6px;
				padding: 6px;
			}

			/* åˆ†é¡å€å¡Šå›ºå®šå…©è¡Œ */
			.category-buttons {
				display: flex;
				flex-wrap: wrap;
				overflow-y: auto;
				line-height: 1.6em;
				max-height: calc(1.6em * 2 + 12px);
				min-height: calc(1.6em * 2 + 12px);
				margin-bottom: 6px;
				flex-shrink: 0;
				background: #1e1e1e;
				border-radius: 6px;
				padding: 6px;
			}

			/* å¤§é¡/åˆ†é¡æŒ‰éˆ• */
			.group-buttons button,
			.category-buttons button {
				margin: 2px;
				background-color: #2c2c2c;
				color: #e0e0e0;
				border: 1px solid #555;
				border-radius: 4px;
				cursor: pointer;
				height: 32px;
				/* å›ºå®šé«˜åº¦ï¼Œè·Ÿ tag ä¸€è‡´ */
				line-height: 22px;
				padding: 0 8px;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}

			/* å·¦å´æ¬„ */
			.left {
				width: 100% !important;
				max-width: 100% !important;
				box-sizing: border-box;
				max-height: 40vh;
				display: flex;
				flex-direction: column;
				flex-shrink: 0;
				/* é˜²æ­¢è¢«å£“ç¸® */
				min-height: 200px;
				/* ä¿åº•é«˜åº¦ */
			}

			/* TAG å›ºå®šä¸‰è¡ŒåŠ */
			.tag-list {
				display: flex;
				flex-wrap: wrap;
				overflow-y: auto;
				line-height: 1.6em;
				max-height: calc(1.6em * 6.9);
				min-height: calc(1.6em * 6.9);
				flex-shrink: 0;
			}

			/* æ‰‹æ©Ÿç‰ˆæ¨¡æ¿éµ */
			#templateToggle.mobile-only {
				display: block;
				background-color: #2c2c2c;
				color: #e0e0e0;
				border: 1px solid #555;
				border-radius: 4px;
				padding: 6px 10px;
				text-align: left;
				height: 38px;
			}

			.template-box {
				display: none;
				position: fixed;
				bottom: 70px;
				left: 5%;
				width: 90%;
				max-height: 60vh;
				overflow-y: auto;
				background: #1e1e1e;
				border: 1px solid #444;
				border-radius: 8px;
				padding: 10px;
				z-index: 1000;
			}

			.template-box.show {
				display: block;
			}

			.right {
				width: 100% !important;
				max-width: 100% !important;
				box-sizing: border-box;
				flex-grow: 1;
				max-height: 43.2vh;
				overflow-y: auto;
				padding-right: 0;
				padding-left: 0;
				padding-bottom: 90px;
			}

			/* footer æ”¹æˆä¸Šä¸‹å…©åˆ— */
			.footer-controls {
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				background: #1e1e1e;
				display: flex;
				flex-direction: column;
				/* ä¸Šä¸‹æ’åˆ— */
				gap: 6px;
				padding: 10px;
				z-index: 999;
			}

			.footer-row1,
			.footer-row2 {
				display: flex;
				align-items: center;
				gap: 8px;
				width: 100%;
				box-sizing: border-box;
				padding: 0 10px;
				/* âœ… å·¦å³éƒ½ç•™ 6px å…§ç¸® */
			}

			/* èªè¨€éµèˆ‡æ¨¡æ¿éµå›ºå®šå¯¬åº¦ */
			#languageSelect,
			#templateToggle.mobile-only {
				width: 80px;
				min-width: 80px;
				max-width: 80px;
				box-sizing: border-box;
			}

			/* å››å€‹åŠŸèƒ½éµå›ºå®šå¯¬åº¦ä¸¦ç½®ä¸­ */
			.footer-row1 .right-buttons button,
			.footer-row2 .right-buttons button {
				width: 120px;
				min-width: 120px;
				max-width: 120px;
				text-align: center;
				flex-shrink: 0;
			}

			/* å³å´æŒ‰éˆ•ç¾¤çµ„ */
			.footer-row1 .right-buttons button,
			.footer-row2 .right-buttons button {
				flex: 1 1 45%;
				/* âœ… å…©é¡†æŒ‰éˆ•ä¸¦æ’å„ä½”ç´„ä¸€åŠ */
				max-width: 120px;
				/* âœ… ä¿æŒä¸Šé™ */
				text-align: center;
			}


			/* éš±è—èªè¨€æ¨™ç±¤æ–‡å­— */
			.topbar label[for="languageSelect"] {
				display: none !important;
			}

			/* èª¿æ•´èªè¨€é¸å–®æ¨£å¼ */
			.footer-controls #languageSelect {
				-webkit-appearance: none;
				appearance: none;
				background-color: #2c2c2c;
				color: #e0e0e0;
				border: 1px solid #555;
				padding: 6px 8px;
				border-radius: 4px;
				font-size: 14px;
			}
		}

		/* å·²å„²å­˜çš„æ¨¡æ¿ - æ©«å¼æ’åˆ— */
		#templateList {
			display: flex;
			flex-wrap: wrap;
			/* è‡ªå‹•æ›è¡Œ */
			gap: 10px;
			/* é–“è· */
			margin-top: 10px;
		}

		#templateList .template-item {
			flex: 0 0 auto;
			/* å›ºå®šå¤§å°ï¼Œä¸è¦æ‹‰é•· */
			min-width: 150px;
			/* æ¯å€‹å¡ç‰‡æœ€å°å¯¬åº¦ */
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 8px;
			background: #f9f9f9;
			text-align: center;
			cursor: pointer;
			transition: background 0.2s;
		}


		#templateList .template-item:hover {
			background: #eaeaea;
		}
	</style>
</head>

<body>
	<!-- å·¦é‚Šæ¬„ -->
	<div class="left">
		<div class="topbar">
			<label for="languageSelect">ä»‹é¢èªè¨€:</label>
			<select id="languageSelect">
				<option value=zh>ä¸­æ–‡</option>
				<option value=en>English</option>
				<option value=jp>æ—¥æœ¬èª</option>
			</select>

			<!-- ğŸ“‚ æ¨¡æ¿éµè¦æ”¾åœ¨é€™è£¡ï¼Œç·Šè²¼èªè¨€é¸å–®ä¸‹é¢ -->
			<button id="templateToggle" class="mobile-only">ğŸ“‚ æ¨¡æ¿</button>
		</div>

		<!-- æ–°å¢å¤§é¡æŒ‰éˆ•åˆ—ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆæœƒé¡¯ç¤ºï¼‰ -->
		<div class="group-buttons" id="groupButtons"></div>
		<div class="category-buttons" id="categories"></div>
		<div class="tag-list" id="tagList"></div>


		<div class="template-box">
			<input type="text" id="templateName" placeholder="æ¨¡æ¿åç¨±">
			<button onclick="saveTemplate()">ğŸ’¾ å„²å­˜æ¨¡æ¿</button>
			<button onclick="downloadTemplates()">â¬‡ ä¸‹è¼‰æ¨¡æ¿</button>
			<input type="file" id="uploadInput" onchange="uploadTemplates()" style="margin-top: 6px;">
			<div id="templateList"></div>
		</div>
	</div>

	<!-- å³é‚Šæ¬„ -->
	<div class="right">
		<div id="outputs"></div>
		<div class="footer-controls">
			<div class="left-buttons">
				<button onclick="addOutput()">â• Add Output</button>
				<button onclick="removeLast()">â– Remove Last</button>
			</div>
			<div class="right-buttons">
				<button onclick="clearAll()">ğŸ—‘ï¸ Clear All</button>
				<button onclick="copyAll()">ğŸ“‹ Copy All</button>
			</div>
		</div>
	</div>
	<script>
		const rawData = [
			{
				category: { key: "Common words", zh: "å¸¸ç”¨", en: "Common words", jp: "åŸºæœ¬" },
				groups: [
					{
						subCategory: "æˆ°å ´",
						tags: [
							{ zh: "æˆ°å ´", en: "battlefield", jp: "æˆ¦å ´", value: "battlefield" },
							{ zh: "å»¢å¢Ÿæˆ°å ´", en: "ruined battlefield", jp: "å»ƒå¢Ÿã®æˆ¦å ´", value: "ruined battlefield" },
							{ zh: "ç‡ƒç‡’çš„æˆ°å ´", en: "burning battlefield", jp: "ç‡ƒãˆã‚‹æˆ¦å ´", value: "burning battlefield" },
							{ zh: "è¿‘æˆ°å»æ®º", en: "close combat scene", jp: "æ¥è¿‘æˆ¦ã‚·ãƒ¼ãƒ³", value: "close combat scene" },
							{ zh: "é ç¨‹äº¤ç«", en: "ranged firefight", jp: "é è·é›¢éŠƒæ’ƒæˆ¦", value: "ranged firefight" }
						]
					}
				]
			},
			{
				category: { key: "pattern", zh: "èŠ±ç´‹èˆ‡åœ–æ¡ˆ", en: "pattern", jp: "æŸ„ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³" },
				groups: [
					{
						subCategory: "æè³ª",
						tags: [
							{ zh: "è•¾çµ²", en: "lace", jp: "ãƒ¬ãƒ¼ã‚¹", value: "lace" },
							{ zh: "çµ²ç¶¢", en: "silk", jp: "ã‚·ãƒ«ã‚¯", value: "silk" },
							{ zh: "ç·é¢", en: "satin", jp: "ã‚µãƒ†ãƒ³", value: "satin" },
							{ zh: "å¤©éµçµ¨", en: "velvet", jp: "ãƒ™ãƒ«ãƒ™ãƒƒãƒˆ", value: "velvet" }
						]
					},
					{
						subCategory: "èŠ±ç´‹",
						tags: [
							{ zh: "è¿·å½©", en: "camouflage", jp: "è¿·å½©", value: "camouflage" },
							{ zh: "æ¢ç´‹", en: "stripes", jp: "ã‚¹ãƒˆãƒ©ã‚¤ãƒ—", value: "stripes" },
							{ zh: "æ°´ç‰é»", en: "polka dots", jp: "æ°´ç‰æ¨¡æ§˜", value: "polka dots" },
							{ zh: "æ ¼å­", en: "checkered", jp: "ãƒã‚§ãƒƒã‚¯æŸ„", value: "checkered" }
						]
					}
				]
			}

		]

		// å¤§é¡è³‡æ–™ï¼Œå°æ‡‰ rawData çš„ category.key
		const groupData = [
			{ group: { key: "Common", zh: "å¸¸ç”¨", en: "Basic", jp: "åŸºæœ¬" }, classification: ["Common words", "angle"] },
			{ group: { key: "pattern all", zh: "èŠ±ç´‹", en: "pattern", jp: "æŸ„" }, classification: ["pattern"] }
		];

		let currentGroupKey = groupData[0].group.key;

		// ğŸ”§ è‡ªå‹•è½‰æ›ç‚º categories èˆ‡ jsonDataï¼ˆç¨‹å¼ç”¨ï¼‰
		const categories = {};
		const jsonData = {};
		rawData.forEach(group => {
			const { key, zh, en, jp } = group.category;
			categories[key] = { zh, en, jp };

			// ğŸ”½ æ‰å¹³åŒ–æ‰€æœ‰å­åˆ†é¡çš„ tags
			const allTags = [];
			if (group.groups) {
				group.groups.forEach(sub => {
					sub.tags.forEach(tag => {
						allTags.push({
							label: { zh: tag.zh, en: tag.en, jp: tag.jp },
							value: tag.value
						});
					});
				});
			}

			jsonData[key] = allTags;
		});

		let currentLang = 'zh';
		let currentCategory = Object.keys(jsonData)[0];
		let currentOutputIndex = 0;
		let outputData = [];
		let templateData = [];

		function saveToLocal() {
			localStorage.setItem("aitagTemplates", JSON.stringify(templateData));
		}
		function loadFromLocal() {
			const saved = localStorage.getItem("aitagTemplates");
			if (saved) {
				try {
					templateData = JSON.parse(saved);
				} catch {
					templateData = [];
				}
			}
		}

		function downloadTemplates() {
			const checkboxes = document.querySelectorAll(".template-checkbox:checked");
			if (!checkboxes.length) return alert("è«‹å‹¾é¸æ¬²ä¸‹è¼‰çš„æ¨¡æ¿");

			const selected = Array.from(checkboxes).map(cb => templateData[parseInt(cb.dataset.index)]);
			const blob = new Blob([JSON.stringify(selected, null, 2)], { type: "application/json" });
			const url = URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			a.download = "selected_templates.json";
			a.click();
			URL.revokeObjectURL(url);
		}

		function uploadTemplates() {
			const input = document.getElementById("uploadInput");
			const file = input.files[0];
			if (!file) return;
			const reader = new FileReader();
			reader.onload = (e) => {
				try {
					const newTemplates = JSON.parse(e.target.result);
					if (!Array.isArray(newTemplates)) throw new Error("æ ¼å¼éŒ¯èª¤");
					newTemplates.forEach(t => {
						if (t.name && t.data) templateData.push(t);
					});
					saveToLocal();
					renderTemplateList();
					updateAllTagHighlight();
				} catch {
					alert("æ¨¡æ¿æ ¼å¼éŒ¯èª¤");
				}
			};
			reader.readAsText(file);
			input.value = "";
		}

		function renderTemplateList() {
			const container = document.getElementById("templateList");
			container.innerHTML = "";
			templateData.forEach((tpl, idx) => {
				const checkbox = document.createElement("input");
				checkbox.type = "checkbox";
				checkbox.className = "template-checkbox";
				checkbox.dataset.index = idx;

				const btn = document.createElement("button");
				btn.textContent = tpl.name;
				btn.onclick = () => {
					applyTemplate(idx);
					updateAllTagHighlight();
				};

				const del = document.createElement("span");
				del.textContent = "âœ•";
				del.onclick = () => {
					templateData.splice(idx, 1);
					saveToLocal();
					renderTemplateList();
				};

				const wrapper = document.createElement("div");
				wrapper.appendChild(checkbox);
				wrapper.appendChild(btn);
				wrapper.appendChild(del);
				container.appendChild(wrapper);
			});
		}

		function saveTemplate() {
			const name = document.getElementById("templateName").value.trim();
			if (!name) return alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±ï¼");
			if (templateData.length >= 10) return alert("æœ€å¤šåªèƒ½å„²å­˜ 10 å€‹æ¨¡æ¿ï¼");
			if (templateData.some(t => t.name === name)) return alert("åç¨±é‡è¤‡ï¼Œè«‹æ›ä¸€å€‹åç¨±");
			const template = {
				name: name,
				data: JSON.parse(JSON.stringify(outputData))
			};
			templateData.push(template);
			saveToLocal();
			renderTemplateList();
			document.getElementById("templateName").value = "";
		}
		function applyTemplate(index) {
			const t = templateData[index];
			if (!t) return;
			outputData = [];
			outputsDiv.innerHTML = "";
			outputData = JSON.parse(JSON.stringify(t.data));
			outputData.forEach((_, i) => createOutputBox(i));
		}
		function renderCategoryButtons() {
			categoriesDiv.innerHTML = '';
			Object.keys(jsonData).forEach((key) => {
				const btn = document.createElement('button');
				btn.textContent = categories[key][currentLang] || key;
				btn.onclick = () => {
					currentCategory = key;
					renderTags(key);
				};
				categoriesDiv.appendChild(btn);
			});
		}

		function renderTags(categoryKey) {
			tagListDiv.innerHTML = '';

			const categoryData = rawData.find(c => c.category.key === categoryKey);
			if (!categoryData) return;

			const categoryEl = renderCategory(categoryData);
			tagListDiv.appendChild(categoryEl);

			updateAllTagHighlight();
		}

		function renderCategory(categoryData) {
			const container = document.createElement("div");
			container.className = "tag-category";

			// ä¸»åˆ†é¡æ¨™é¡Œ
			const mainTitle = document.createElement("h3");
			mainTitle.textContent = categoryData.category.zh;
			container.appendChild(mainTitle);

			// å­åˆ†é¡
			categoryData.groups.forEach(group => {
				const groupDiv = document.createElement("div");
				groupDiv.className = "tag-subcategory";

				const subTitle = document.createElement("h4");
				subTitle.textContent = group.subCategory;
				groupDiv.appendChild(subTitle);

				// tags
				group.tags.forEach(tag => {
					const btn = document.createElement("button");
					btn.className = "tag";   // âœ… çµ±ä¸€ç”¨ .tag
					btn.textContent = tag.zh;
					btn.dataset.value = tag.value;  // âœ… è®“ updateAllTagHighlight èƒ½æ‰¾åˆ°å°æ‡‰å€¼

					//Add weight
					const weight = document.createElement('span');
					weight.className = 'weight-control';
					weight.innerHTML = '<button class="wplus">+</button><button class="wminus">-</button>';
					weight.querySelector('.wplus').onclick = e => {
						e.stopPropagation();
						const added = autoAdjustWeight(tag.value, 0.1);
						if (!added) {
							const match = tag;
							match.weight = 1.0;
							addTagToCurrent(match);
						}
						updateAllTagHighlight();
					};
					weight.querySelector('.wminus').onclick = e => {
						e.stopPropagation();
						autoAdjustWeight(tag.value, -0.1);
						updateAllTagHighlight();
					};
					btn.appendChild(weight);

					btn.addEventListener("click", () => {
						toggleTag(btn, tag);   // âœ… ç”¨ toggleTag æ­£ç¢ºåŠ å…¥/åˆªé™¤
						updateAllTagHighlight();
					});

					groupDiv.appendChild(btn);
				});


				container.appendChild(groupDiv);
			});

			return container;
		}



		function autoAdjustWeight(value, delta) {
			const found = outputData.findIndex(arr => arr.some(t => t.value === value || t.value.startsWith(`${value}:`)));
			if (found !== -1) {
				currentOutputIndex = found;
				updateOutputHighlight();
				adjustTagWeight(value, delta);
				return true;
			}
			return false;
		}

		function adjustTagWeight(value, delta) {
			const tag = outputData[currentOutputIndex].find(t => t.value === value || t.value.startsWith(`${value}:`));
			if (!tag) return;
			const currentWeight = tag.weight || parseFloat((tag.value.match(/:(\d+(\.\d+)?)\)$/) || [])[1]) || 1.0;
			const newWeight = Math.max(0.1, Math.min(2.0, +(currentWeight + delta).toFixed(1)));
			tag.weight = newWeight;
			updateOutput(currentOutputIndex);
			updateAllTagHighlight();
		}

		function toggleTag(el, tagObj) {
			// æª¢æŸ¥é€™å€‹ tag åœ¨å“ªäº› output è£¡å­˜åœ¨
			const foundIndex = outputData.findIndex(arr =>
				arr.some(t => t.value === tagObj.value)
			);

			if (foundIndex !== -1 && foundIndex !== currentOutputIndex) {
				// ğŸ‘‰ å¦‚æœå·²ç¶“å­˜åœ¨æ–¼å…¶ä»– Output
				currentOutputIndex = foundIndex;       // è·³åˆ°è©² Output
				updateOutputHighlight();               // æ›´æ–°é«˜äº®é¡¯ç¤º
				removeTag(foundIndex, tagObj.value);   // ä¸¦åœ¨è©² Output ç§»é™¤
				return;
			}

			// ğŸ‘‰ åŸæœ¬æµç¨‹ï¼šåœ¨ç•¶å‰ Output åšæ–°å¢æˆ–åˆªé™¤
			const isSelected = el.classList.toggle('selected');
			if (isSelected) {
				addTagToCurrent(tagObj);
			} else {
				removeTag(currentOutputIndex, tagObj.value);
			}
		}



		function createOutputBox(index) {
			const box = document.createElement('div');
			box.className = 'output-box';
			box.onclick = () => {
				currentOutputIndex = index;
				updateOutputHighlight();
			};

			const tagDisplay = document.createElement('div');
			tagDisplay.className = 'output-tags';
			const textarea = document.createElement('textarea');
			textarea.oninput = () => {
				const values = textarea.value.split(',').map(t => t.trim()).filter(t => t);
				outputData[index] = values.map(v => {
					for (let cat in jsonData) {
						const match = jsonData[cat].find(t => t.value === v);
						if (match) return match;
					}
					return { label: { zh: v, en: v, jp: v }, value: v };
				});
				renderTagDisplay(index);
				updateAllTagHighlight();
			};
			const controls = document.createElement('div');
			controls.className = 'output-controls';
			const copyBtn = document.createElement('button');
			copyBtn.textContent = 'ğŸ“‹';
			copyBtn.onclick = (e) => {
				e.stopPropagation();
				navigator.clipboard.writeText(textarea.value);
			};
			const clearBtn = document.createElement('button');
			clearBtn.textContent = 'ğŸ—‘ï¸';
			clearBtn.onclick = (e) => {
				e.stopPropagation();
				outputData[index] = [];
				updateOutput(index);
				updateAllTagHighlight();
			};
			controls.appendChild(copyBtn);
			controls.appendChild(clearBtn);
			box.appendChild(tagDisplay);
			box.appendChild(textarea);
			box.appendChild(controls);
			outputsDiv.appendChild(box);
			updateOutput(index);
		}

		function renderTagDisplay(index) {
			const tagContainer = outputsDiv.children[index].querySelector('.output-tags');
			tagContainer.innerHTML = '';
			outputData[index].forEach(tag => {

				// å…ˆå˜—è©¦ç›´æ¥ç”¨æ—¢æœ‰ label
				let displayText = (tag.label && tag.label[currentLang]) ? tag.label[currentLang] : null;

				// å¦‚æœæ²’æœ‰ labelï¼Œå» rawData è£¡æ¯”å° value
				if (!displayText) {
					for (const group of rawData) {
						for (const sub of group.groups) {
							const match = sub.tags.find(t => t.value === tag.value);
							if (match) {
								displayText = match[currentLang]; // zh / en / jp
								break;
							}
						}
						if (displayText) break;
					}
				}

				// ä»æ‰¾ä¸åˆ°å°± fallback ç‚º value
				if (!displayText) displayText = tag.value;

				const tagEl = document.createElement('div');
				tagEl.className = 'output-tag';
				tagEl.innerHTML = `${displayText}<span onclick="removeTag(${index}, '${tag.value.replace(/'/g, "\\'")}')">âœ•</span>`;
				tagContainer.appendChild(tagEl);
			});
		}


		function removeTag(index, value) {
			// åˆªæ‰è©² output è£¡çš„ tag
			outputData[index] = outputData[index].filter(t => t.value !== value);

			// æ›´æ–° output æ¬„å…§å®¹
			updateOutput(index);

			// é‡æ–°æ•´ç†æ‰€æœ‰ TAG é«˜äº®ç‹€æ…‹
			updateAllTagHighlight();
		}


		function updateOutput(index) {
			const text = outputData[index].map(t => {
				if (t.weight && t.weight !== 1.0) {
					return `(${t.value}:${t.weight}), `;
				}
				return `${t.value}, `;
			}).join('');
			outputsDiv.children[index].querySelector('textarea').value = text;
			renderTagDisplay(index);
			updateOutputHighlight();
		}

		function updateOutputHighlight() {
			document.querySelectorAll('.output-box').forEach((el, i) => {
				el.classList.toggle('selected', i === currentOutputIndex);
			});
			updateAllTagHighlight();
		}

		function updateAllTagHighlight() {
			// æ”¶é›†æ‰€æœ‰ output è£¡é‚„å­˜åœ¨çš„ tag
			const selected = new Set(outputData.flat().map(t => t.value));

			document.querySelectorAll('.tag').forEach(el => {
				el.classList.toggle('selected', selected.has(el.dataset.value));
			});
		}



		function addTagToCurrent(tagObj) {
			const exists = outputData[currentOutputIndex].some(t => t.value === tagObj.value);
			if (!exists) {
				const cleanTag = JSON.parse(JSON.stringify(tagObj));
				delete cleanTag.weight; // ç¢ºä¿é‡è¨­ç‚ºç„¡æ¬Šé‡
				outputData[currentOutputIndex].push(cleanTag);
				updateOutput(currentOutputIndex);
				updateAllTagHighlight();
			}
		}
		function copyAll() {
			const allText = outputData.map(arr =>
				arr.map(t => {
					if (t.weight && t.weight !== 1) {
						return `(${t.value}:${t.weight}), `;
					} else {
						return `${t.value}, `;
					}
				}).join('')
			).join('\nBREAK\n');

			// å˜—è©¦ç”¨æ–° API
			if (navigator.clipboard && window.isSecureContext) {
				navigator.clipboard.writeText(allText).catch(err => {
					console.error("Clipboard API å¤±æ•—:", err);
				});
			} else {
				// fallback æ–¹æ³•ï¼ˆå…¼å®¹ file:// æ¡Œæ©Ÿï¼‰
				const textarea = document.createElement("textarea");
				textarea.value = allText;
				document.body.appendChild(textarea);
				textarea.select();
				document.execCommand("copy");
				document.body.removeChild(textarea);
			}
		}

		function clearAll() {
			for (let i = 0; i < outputData.length; i++) {
				outputData[i] = [];
				updateOutput(i);
			}
			updateAllTagHighlight();
		}
		function addOutput() {
			const newIndex = outputData.length;
			outputData.push([]);
			createOutputBox(newIndex);
		}
		function removeLast() {
			if (outputData.length > 1) {
				outputsDiv.removeChild(outputsDiv.lastChild);
				outputData.pop();
				if (currentOutputIndex >= outputData.length) {
					currentOutputIndex = outputData.length - 1;
				}
				updateAllTagHighlight();
			}
		}

		// æ‰‹æ©Ÿå¯¬åº¦æ™‚æŠŠ #languageSelect æ¬åˆ° footer çš„å·¦æŒ‰éˆ•å€ï¼Œæ¡Œæ©Ÿæ™‚é‚„åŸ
		(function () {
			function moveLanguageSelect() {
				const select = document.getElementById('languageSelect');
				const label = document.querySelector('label[for="languageSelect"]');
				const templateToggle = document.getElementById('templateToggle');
				const footerControls = document.querySelector('.footer-controls');
				const topbar = document.querySelector('.topbar');

				if (!select || !footerControls || !templateToggle || !topbar) return;

				// æŠŠåŸæœ¬ footer è£¡çš„å·¦å³ç¾¤çµ„å…ˆæŠ“å‡ºä¾†ï¼ˆå¯èƒ½æœƒ later è¢«ç§»é™¤ï¼‰
				const origLeft = footerControls.querySelector('.left-buttons');
				const origRight = footerControls.querySelector('.right-buttons');

				if (window.innerWidth <= 768) {
					// æ‰‹æ©Ÿç‰ˆï¼šéš±è— label
					if (label) label.style.display = 'none';

					// å»ºç«‹ row1ã€row2ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
					let row1 = footerControls.querySelector('.footer-row1');
					let row2 = footerControls.querySelector('.footer-row2');
					if (!row1) {
						row1 = document.createElement('div');
						row1.className = 'footer-row1';
						// æ”¾åœ¨ footerControls æœ€å‰é¢
						footerControls.insertBefore(row1, footerControls.firstChild);
					}
					if (!row2) {
						row2 = document.createElement('div');
						row2.className = 'footer-row2';
						footerControls.appendChild(row2);
					}

					// åœ¨ row1ã€row2 å„è‡ªå»ºç«‹ .right-buttons ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
					let row1Right = row1.querySelector('.right-buttons');
					if (!row1Right) {
						row1Right = document.createElement('div');
						row1Right.className = 'right-buttons';
						row1.appendChild(row1Right);
					}
					let row2Right = row2.querySelector('.right-buttons');
					if (!row2Right) {
						row2Right = document.createElement('div');
						row2Right.className = 'right-buttons';
						row2.appendChild(row2Right);
					}

					// æŠŠèªè¨€é¸å–®ç§»åˆ° row1 å·¦å´ï¼ˆè‹¥å°šæœªç§»ï¼‰
					if (!row1.contains(select)) row1.insertBefore(select, row1.firstChild);

					// æŠŠåŸæœ¬ footer çš„ left-buttons è£¡é¢çš„æŒ‰éˆ•ï¼ˆAdd/Removeï¼‰æ¬åˆ° row1Right
					if (origLeft) {
						while (origLeft.firstChild) {
							row1Right.appendChild(origLeft.firstChild);
						}
						// ç§»å®Œå°±åˆªæ‰ç©ºçš„ containerï¼Œé¿å…æ®˜ç•™
						origLeft.remove();
					} else {
						// fallbackï¼šè‹¥æ‰¾ä¸åˆ° origLeftï¼Œå˜—è©¦ç›´æ¥æŠ“å‡½å¼åç¨±ä¾†æ‰¾æŒ‰éˆ•
						const btnAdd = footerControls.querySelector('button[onclick*="addOutput"]');
						const btnRemove = footerControls.querySelector('button[onclick*="removeLast"]');
						if (btnAdd && !row1Right.contains(btnAdd)) row1Right.appendChild(btnAdd);
						if (btnRemove && !row1Right.contains(btnRemove)) row1Right.appendChild(btnRemove);
					}

					// æŠŠæ¨¡æ¿éµæ”¾åˆ° row2 å·¦å´
					if (!row2.contains(templateToggle)) row2.insertBefore(templateToggle, row2.firstChild);

					// æŠŠåŸæœ¬ footer çš„ right-buttonsï¼ˆClear/Copyï¼‰æ¬åˆ° row2Right
					if (origRight) {
						// æ³¨æ„ï¼šorigRight å¯èƒ½æ˜¯æˆ‘å€‘å‰›å‰›æ–°å»ºçš„ row1Right/row2Right çš„å…¶ä¸­ä¸€å€‹ï¼Œåªæœ‰åœ¨å®ƒä¸æ˜¯å‰›å‰›å»ºç«‹çš„ container æ‰æ¬
						if (origRight !== row1Right && origRight !== row2Right) {
							while (origRight.firstChild) {
								row2Right.appendChild(origRight.firstChild);
							}
							origRight.remove();
						} else {
							// fallbackï¼šæ‰¾æŒ‡å®šæŒ‰éˆ•æ¬ç§»
							const btnClear = footerControls.querySelector('button[onclick*="clearAll"]');
							const btnCopy = footerControls.querySelector('button[onclick*="copyAll"]');
							if (btnClear && !row2Right.contains(btnClear)) row2Right.appendChild(btnClear);
							if (btnCopy && !row2Right.contains(btnCopy)) row2Right.appendChild(btnCopy);
						}
					} else {
						const btnClear = footerControls.querySelector('button[onclick*="clearAll"]');
						const btnCopy = footerControls.querySelector('button[onclick*="copyAll"]');
						if (btnClear && !row2Right.contains(btnClear)) row2Right.appendChild(btnClear);
						if (btnCopy && !row2Right.contains(btnCopy)) row2Right.appendChild(btnCopy);
					}

				} else {
					// æ¡Œæ©Ÿç‰ˆï¼šé‚„åŸ

					if (label) label.style.display = '';

					// å»ºç«‹ footer-level çš„ left-buttonsã€right-buttonsï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
					let newLeft = footerControls.querySelector('.left-buttons');
					if (!newLeft) {
						newLeft = document.createElement('div');
						newLeft.className = 'left-buttons';
						footerControls.insertBefore(newLeft, footerControls.firstChild);
					}
					// create a footer-level right-buttons at end if not exists
					let newRight = null;
					// è‹¥ footerControls æœ€åº•å·²ç¶“æœ‰ .right-buttons ä¸”ä¸æ˜¯ row containerï¼Œæ‹¿ä¾†ç”¨
					footerControls.querySelectorAll(':scope > .right-buttons').forEach(el => newRight = el);
					if (!newRight) {
						newRight = document.createElement('div');
						newRight.className = 'right-buttons';
						footerControls.appendChild(newRight);
					}

					// å¦‚æœæˆ‘å€‘ä¹‹å‰å»ºç«‹äº† row1/row2ï¼Œå¾è£¡é¢æŠŠæŒ‰éˆ•æ¬å›æ–°å»ºçš„ left/right
					const row1 = footerControls.querySelector('.footer-row1');
					const row2 = footerControls.querySelector('.footer-row2');

					if (row1) {
						// row1 å…§å¯èƒ½æœ‰ select èˆ‡ row1Right
						const r1Right = row1.querySelector('.right-buttons');
						if (r1Right) {
							while (r1Right.firstChild) {
								newLeft.appendChild(r1Right.firstChild);
							}
						}
						// æŠŠ select é‚„åŸå› topbarï¼ˆæ”¾åœ¨ label å¾Œï¼‰
						if (!topbar.contains(select)) {
							if (label && label.parentNode) label.parentNode.insertBefore(select, label.nextSibling);
							else topbar.appendChild(select);
						}
					}

					if (row2) {
						const r2Right = row2.querySelector('.right-buttons');
						if (r2Right) {
							while (r2Right.firstChild) {
								newRight.appendChild(r2Right.firstChild);
							}
						}
						// æŠŠ templateToggle é‚„å› topbarï¼ˆdesktop CSS æœƒéš±è—å®ƒï¼‰
						if (!topbar.contains(templateToggle)) topbar.appendChild(templateToggle);
					}

					// æœ€å¾ŒæŠŠ row1 / row2 åˆªæ‰ï¼ˆæ¸…ä¹¾æ·¨ï¼‰
					if (row1) row1.remove();
					if (row2) row2.remove();
				}
			}

			// ç¶å®šäº‹ä»¶ï¼ˆå·²å­˜åœ¨ä¹Ÿæ²’é—œä¿‚ï¼‰
			window.addEventListener('DOMContentLoaded', moveLanguageSelect);
			window.addEventListener('resize', moveLanguageSelect);
			window.addEventListener('orientationchange', moveLanguageSelect);
		})();

		function renderGroupButtons() {
			const container = document.getElementById("groupButtons");
			if (!container) return;
			container.innerHTML = "";
			groupData.forEach(g => {
				const btn = document.createElement("button");
				btn.textContent = g.group[currentLang] || g.group.key;
				if (g.group.key === currentGroupKey) btn.classList.add("active");
				btn.onclick = () => {
					currentGroupKey = g.group.key;
					currentCategory = g.classification[0];
					renderGroupButtons();              // é‡æ–°æ¸²æŸ“ â†’ æ›´æ–°é«˜äº®
					renderCategoryButtons_mobile();
					renderTags(currentCategory);
				};
				container.appendChild(btn);
			});
		}

		function renderCategoryButtons_mobile() {
			categoriesDiv.innerHTML = '';
			const group = groupData.find(g => g.group.key === currentGroupKey);
			if (!group) return;
			group.classification.forEach(key => {
				const category = categories[key];
				if (!category) return;
				const btn = document.createElement('button');
				btn.textContent = category[currentLang] || key;
				if (key === currentCategory) btn.classList.add("active");
				btn.onclick = () => {
					currentCategory = key;
					renderCategoryButtons_mobile();    // é‡æ–°æ¸²æŸ“ â†’ æ›´æ–°é«˜äº®
					renderTags(key);
				};
				categoriesDiv.appendChild(btn);
			});
		}

		document.addEventListener("DOMContentLoaded", () => {
			const toggleBtn = document.getElementById("templateToggle");
			const templateBox = document.querySelector(".template-box");

			if (toggleBtn && templateBox) {
				toggleBtn.onclick = () => {
					templateBox.classList.toggle("show");
				};
			}
		});



		window.addEventListener("DOMContentLoaded", () => {
			categoriesDiv = document.getElementById('categories');
			tagListDiv = document.getElementById('tagList');
			outputsDiv = document.getElementById('outputs');
			languageSelect = document.getElementById('languageSelect');
			templateList = document.getElementById('templateList');

			loadFromLocal();

			if (window.innerWidth <= 768) {
				renderGroupButtons();
				renderCategoryButtons_mobile();
				renderTags(currentCategory);
			} else {
				renderCategoryButtons();
				renderTags(currentCategory);
			}
			for (let i = 0; i < 3; i++) {
				outputData.push([]);
				createOutputBox(i);
			}
			renderTemplateList();
			languageSelect.onchange = () => {
				currentLang = languageSelect.value;

				if (window.innerWidth <= 768) {
					renderGroupButtons();
					renderCategoryButtons_mobile();
					renderTags(currentCategory);
				} else {
					renderCategoryButtons();
					renderTags(currentCategory);
				}
				outputData.forEach((_, i) => renderTagDisplay(i));
				updateOutputHighlight();
			};
		});



	</script>
</body>

</html>